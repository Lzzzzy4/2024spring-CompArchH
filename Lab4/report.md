# Lab4实验报告

## PB21000164 来泽远

## BTB

维护如下变量，分别记录跳转指令的pc，跳转的位置，近期是否跳转，以及是否有效。

```verilog
reg [31:0]pc_tbl[BUF_LEN];
reg [31:0]branch_target[BUF_LEN];
reg [BUF_LEN - 1:0]state;
reg [BUF_LEN - 1:0]valid;
```

在遇到一条跳转指令（EX段）时更新，若跳转则置state为1。

## BHT

维护bht表。

```verilog
reg [1:0]bht[4096];
```

在BTB基础上加入`2*N`的cache buffer用于维护计数器。使用pc低地址寻址，如跳转则+1，不跳转则-1。预测跳转的条件是$\ge 2$。此外还需要求BTB也给出预测跳转，当且仅当两者同时跳转时则预测跳转。

## 测试结果

分支收益/代价：两个周期。

### btb.s

|        | 总周期/差值 | 总分支 | 正确预测 | 正确率  |
| ------ | ----------- | ------ | -------- | ------- |
| Static | 509         | 101    | 1        | 1.00 %  |
| BTB    | 311/198     | 101    | 99       | 98.02 % |
| BHT    | 313/196     | 101    | 98       | 97.03 % |

### bht.S

|        | 总周期/差值 | 总分支 | 正确预测 | 正确率  |
| ------ | ----------- | ------ | -------- | ------- |
| Static | 535         | 110    | 11       | 10.00 % |
| BTB    | 379/156     | 110    | 88       | 80.00 % |
| BHT    | 361/174     | 110    | 97       | 88.18 % |

### QuickSort.S

|        | 总周期/差值 | 总分支 | 正确预测 | 正确率  |
| ------ | ----------- | ------ | -------- | ------- |
| Static | 56013       | 6384   | 4693     | 73.51 % |
| BTB    | 56589/-576  | 6384   | 4404     | 68.98 % |
| BHT    | 55373/640   | 6384   | 5215     | 81.69 % |

### Matmul.py

|        | 总周期/差值 | 总分支 | 正确预测 | 正确率  |
| ------ | ----------- | ------ | -------- | ------- |
| Static | 306164      | 4624   | 274      | 5.93 %  |
| BTB    | 298558/7606 | 4624   | 4076     | 88.15 % |
| BHT    | 298018/8146 | 4624   | 4346     | 93.99 % |

### 分析

BHT在大部分测试上都比BTB优异。主要原因是BHT使用2-bit用作信息，来决策是否跳转，更加严谨。比如循环嵌套的模式，BTB只看最近一次跳转情况来决策在多层循环中每一次内循环必定会失效1次，而BHT则不会。

btb.S中只包含了一层循环，则BHT在开始会比BTB多失效一次，是合理的。

bht.S中为双层嵌套循环，如上分析所述。

QuickSort.S与Matmul.S中主要也由复杂的跳转组成，BHT会更加占据优势。
